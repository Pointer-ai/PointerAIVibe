import React, { useState, useEffect } from 'react'
import { getCurrentProfile, getProfileData } from '../utils/profile'
import { 
  getLearningGoals, 
  getLearningPaths, 
  getCourseUnits, 
  getAgentActions,
  deleteLearningGoal,
  deleteLearningPath,
  deleteCourseUnit,
  updateLearningGoal,
  updateLearningPath,
  getGoalStatusStats,
  getCourseUnitsByNode,
  getNodeLearningStats,
  updateCourseProgress,
  markSectionComplete,
  startCourseUnit,
  getCourseStats,
  createCourseUnit,
  // æ–°å¢ï¼šå…³è”ç®¡ç†åŠŸèƒ½
  linkPathToGoal,
  linkCourseUnitToNode,
  unlinkPathFromGoal,
  unlinkCourseUnitFromNode,
  getPathsByGoal,
  getGoalByPath,
  getCourseUnitsByNodeId,
  getSourceByUri,
  syncDataRelationships,
  getLearningHierarchy,
  getRelationshipStats
} from '../modules/coreData'
import { getCurrentAssessment } from '../modules/abilityAssess/service'
import { addActivityRecord } from '../modules/profileSettings/service'
import { agentToolExecutor } from '../modules/coreData'
import { LearningGoal, LearningPath, CourseUnit } from '../modules/coreData/types'
import { EnhancedRelationshipPanel } from './EnhancedRelationshipPanel'
import { DeleteConfirmDialog, useToast } from './common'

export const DataInspector: React.FC = () => {
  const [profileData, setProfileData] = useState<any>(null)
  const [coreData, setCoreData] = useState<any>(null)
  
  // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†çŠ¶æ€
  const [deleteConfirm, setDeleteConfirm] = useState<{
    type: 'goal' | 'path' | 'unit'
    id: string
    title: string
  } | null>(null)
  const [isDeleting, setIsDeleting] = useState(false)

  // Toastç»„ä»¶
  const { showSuccess, showError, ToastContainer } = useToast()

  // å­¦ä¹ è·¯å¾„ç®¡ç†ç›¸å…³çŠ¶æ€
  const [goals, setGoals] = useState<LearningGoal[]>([])
  const [paths, setPaths] = useState<LearningPath[]>([])
  const [selectedGoal, setSelectedGoal] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [message, setMessage] = useState<string>('')
  const [goalStats, setGoalStats] = useState<any>(null)

  // è¯¾ç¨‹å†…å®¹ç®¡ç†ç›¸å…³çŠ¶æ€
  const [courseUnits, setCourseUnits] = useState<CourseUnit[]>([])
  const [selectedNode, setSelectedNode] = useState<string | null>(null)
  const [selectedUnit, setSelectedUnit] = useState<CourseUnit | null>(null)
  const [courseStats, setCourseStats] = useState<any>(null)
  const [showCourseManagement, setShowCourseManagement] = useState(false)

  // æ–°å¢ï¼šå…³è”ç®¡ç†ç›¸å…³çŠ¶æ€
  const [showRelationshipManagement, setShowRelationshipManagement] = useState(false)
  const [relationshipStats, setRelationshipStats] = useState<any>(null)
  const [learningHierarchy, setLearningHierarchy] = useState<any>(null)
  const [selectedPathForLink, setSelectedPathForLink] = useState<string | null>(null)
  const [selectedGoalForLink, setSelectedGoalForLink] = useState<string | null>(null)
  const [selectedNodeForLink, setSelectedNodeForLink] = useState<string | null>(null)
  const [selectedUnitForLink, setSelectedUnitForLink] = useState<string | null>(null)

  const refreshData = () => {
    const profile = getCurrentProfile()
    if (profile) {
      setProfileData({
        profile: profile,
        coreData: getProfileData('coreData'),
        assessment: getProfileData('abilityAssessment'),
        assessmentHistory: getProfileData('assessmentHistory') || []
      })

      setCoreData({
        goals: getLearningGoals(),
        paths: getLearningPaths(),
        courseUnits: getCourseUnits(),
        agentActions: getAgentActions(),
        currentAssessment: getCurrentAssessment()
      })
    }

    // åˆ·æ–°å­¦ä¹ è·¯å¾„ç®¡ç†æ•°æ®
    setGoals(getLearningGoals())
    setPaths(getLearningPaths())
    setGoalStats(getGoalStatusStats())
    
    // åˆ·æ–°è¯¾ç¨‹å†…å®¹ç®¡ç†æ•°æ®
    setCourseUnits(getCourseUnits())
    setCourseStats(getCourseStats())
    
    // åˆ·æ–°å…³è”ç®¡ç†æ•°æ®
    setRelationshipStats(getRelationshipStats())
    setLearningHierarchy(getLearningHierarchy())
  }

  useEffect(() => {
    refreshData()
  }, [])

  // åˆ›å»ºæ–°ç›®æ ‡
  const createNewGoal = async () => {
    setLoading(true)
    try {
      const assessment = getCurrentAssessment()
      
      const goal = await agentToolExecutor.executeTool('create_learning_goal', {
        title: 'æ–°çš„å­¦ä¹ ç›®æ ‡',
        description: 'è¯·ç¼–è¾‘æ­¤ç›®æ ‡çš„è¯¦ç»†ä¿¡æ¯',
        category: 'frontend',
        priority: 3,
        targetLevel: assessment ? 
          (assessment.overallScore >= 70 ? 'advanced' : 
           assessment.overallScore >= 40 ? 'intermediate' : 'beginner') : 'beginner',
        estimatedTimeWeeks: 8,
        requiredSkills: ['ç¼–ç¨‹åŸºç¡€'],
        outcomes: ['æŒæ¡æ–°æŠ€èƒ½']
      })

      setMessage(`âœ… æˆåŠŸåˆ›å»ºç›®æ ‡: ${goal.title}`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ åˆ›å»ºç›®æ ‡å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    } finally {
      setLoading(false)
    }
  }

  // ä¸ºç›®æ ‡ç”Ÿæˆå­¦ä¹ è·¯å¾„
  const generatePathForGoal = async (goalId: string) => {
    setLoading(true)
    try {
      // é¦–å…ˆå†»ç»“ç°æœ‰è·¯å¾„
      const existingPaths = paths.filter(p => p.goalId === goalId && p.status === 'active')
      for (const path of existingPaths) {
        await agentToolExecutor.executeTool('update_learning_path', {
          pathId: path.id,
          updates: { status: 'frozen' }
        })
      }

      // ç”Ÿæˆæ–°çš„å­¦ä¹ è·¯å¾„èŠ‚ç‚¹
      const assessment = getCurrentAssessment()
      const userLevel = assessment ? 
        (assessment.overallScore >= 70 ? 'intermediate' : 
         assessment.overallScore >= 40 ? 'beginner' : 'novice') : 'beginner'

      const nodes = await agentToolExecutor.executeTool('generate_path_nodes', {
        goalId: goalId,
        userLevel: userLevel,
        preferences: { 
          learningStyle: 'project-based', 
          pace: 'normal' 
        }
      })

      // åˆ›å»ºæ–°çš„å­¦ä¹ è·¯å¾„
      const path = await agentToolExecutor.executeTool('create_learning_path', {
        goalId: goalId,
        title: `${goals.find(g => g.id === goalId)?.title} - å­¦ä¹ è·¯å¾„`,
        description: 'ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„',
        nodes: nodes,
        dependencies: [],
        milestones: []
      })

      setMessage(`âœ… æˆåŠŸä¸ºç›®æ ‡ç”Ÿæˆå­¦ä¹ è·¯å¾„: ${path.nodes.length} ä¸ªèŠ‚ç‚¹`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ ç”Ÿæˆè·¯å¾„å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    } finally {
      setLoading(false)
    }
  }

  // æ›´æ–°ç›®æ ‡çŠ¶æ€
  const updateGoalStatus = async (goalId: string, status: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_goal', {
        goalId: goalId,
        updates: { status }
      })

      // å¦‚æœç›®æ ‡è¢«æš‚åœæˆ–å–æ¶ˆï¼Œç›¸å…³è·¯å¾„ä¹Ÿè¦æ›´æ–°
      if (status === 'paused' || status === 'cancelled') {
        const relatedPaths = paths.filter(p => p.goalId === goalId && p.status === 'active')
        for (const path of relatedPaths) {
          await agentToolExecutor.executeTool('update_learning_path', {
            pathId: path.id,
            updates: { status: status === 'paused' ? 'paused' : 'archived' }
          })
        }
      }

      setMessage(`âœ… ç›®æ ‡çŠ¶æ€å·²æ›´æ–°ä¸º: ${status}`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ æ›´æ–°å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // æ›´æ–°è·¯å¾„çŠ¶æ€
  const updatePathStatus = async (pathId: string, status: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status }
      })

      setMessage(`âœ… è·¯å¾„çŠ¶æ€å·²æ›´æ–°ä¸º: ${getStatusText(status)}`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ æ›´æ–°è·¯å¾„çŠ¶æ€å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // æ¿€æ´»å†»ç»“çš„è·¯å¾„
  const activateFrozenPath = async (pathId: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status: 'active' }
      })

      setMessage(`âœ… è·¯å¾„å·²æ¿€æ´»`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ æ¿€æ´»å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // æš‚åœè·¯å¾„
  const pausePath = async (pathId: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status: 'paused' }
      })

      setMessage(`âœ… è·¯å¾„å·²æš‚åœ`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ æš‚åœå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // å®Œæˆè·¯å¾„
  const completePath = async (pathId: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status: 'completed' }
      })

      setMessage(`âœ… è·¯å¾„å·²å®Œæˆ`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ å®Œæˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // æ¢å¤æš‚åœçš„è·¯å¾„
  const resumePath = async (pathId: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status: 'active' }
      })

      setMessage(`âœ… è·¯å¾„å·²æ¢å¤`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ æ¢å¤å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // åˆ é™¤è·¯å¾„
  const deletePathAdvanced = async (pathId: string) => {
    try {
      await agentToolExecutor.executeTool('update_learning_path', {
        pathId: pathId,
        updates: { status: 'archived' }
      })

      setMessage(`âœ… è·¯å¾„å·²å½’æ¡£`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ åˆ é™¤å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // è·å–çŠ¶æ€é¢œè‰²
  const getStatusColor = (status: string): string => {
    switch (status) {
      case 'active': return '#4CAF50'
      case 'completed': return '#2196F3'
      case 'paused': return '#FF9800'
      case 'cancelled': return '#f44336'
      case 'frozen': return '#9E9E9E'
      case 'archived': return '#795548'
      default: return '#6c757d'
    }
  }

  // è·å–çŠ¶æ€ä¸­æ–‡
  const getStatusText = (status: string): string => {
    switch (status) {
      case 'active': return 'è¿›è¡Œä¸­'
      case 'completed': return 'å·²å®Œæˆ'
      case 'paused': return 'å·²æš‚åœ'
      case 'cancelled': return 'å·²å–æ¶ˆ'
      case 'frozen': return 'å·²å†»ç»“'
      case 'archived': return 'å·²å½’æ¡£'
      case 'draft': return 'è‰ç¨¿'
      default: return 'æœªçŸ¥'
    }
  }

  const formatJSON = (obj: any): string => {
    return JSON.stringify(obj, null, 2)
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  }

  const handleDelete = async (type: 'goal' | 'path' | 'unit', id: string, title: string) => {
    setDeleteConfirm({ type, id, title })
  }

  const confirmDelete = async () => {
    if (!deleteConfirm) return

    try {
      let success = false
      let message = ''

      switch (deleteConfirm.type) {
        case 'goal':
          success = deleteLearningGoal(deleteConfirm.id)
          message = success ? 'å­¦ä¹ ç›®æ ‡åˆ é™¤æˆåŠŸ' : 'å­¦ä¹ ç›®æ ‡åˆ é™¤å¤±è´¥'
          break
        case 'path':
          success = deleteLearningPath(deleteConfirm.id)
          message = success ? 'å­¦ä¹ è·¯å¾„åˆ é™¤æˆåŠŸ' : 'å­¦ä¹ è·¯å¾„åˆ é™¤å¤±è´¥'
          break
        case 'unit':
          success = deleteCourseUnit(deleteConfirm.id)
          message = success ? 'è¯¾ç¨‹å•å…ƒåˆ é™¤æˆåŠŸ' : 'è¯¾ç¨‹å•å…ƒåˆ é™¤å¤±è´¥'
          break
      }

      if (success) {
        // è®°å½•åˆ é™¤æ“ä½œåˆ°æ´»åŠ¨å†å²
        addActivityRecord({
          type: 'data_operation',
          action: `åˆ é™¤${deleteConfirm.type === 'goal' ? 'å­¦ä¹ ç›®æ ‡' : deleteConfirm.type === 'path' ? 'å­¦ä¹ è·¯å¾„' : 'è¯¾ç¨‹å•å…ƒ'}`,
          details: {
            itemType: deleteConfirm.type,
            itemId: deleteConfirm.id,
            itemTitle: deleteConfirm.title,
            success: true
          }
        })

        alert(message)
        refreshData()
      } else {
        alert(message)
      }
    } catch (error) {
      const errorMessage = `åˆ é™¤å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`
      alert(errorMessage)
      
      // è®°å½•å¤±è´¥çš„åˆ é™¤æ“ä½œ
      addActivityRecord({
        type: 'data_operation',
        action: `åˆ é™¤${deleteConfirm.type === 'goal' ? 'å­¦ä¹ ç›®æ ‡' : deleteConfirm.type === 'path' ? 'å­¦ä¹ è·¯å¾„' : 'è¯¾ç¨‹å•å…ƒ'}å¤±è´¥`,
        details: {
          itemType: deleteConfirm.type,
          itemId: deleteConfirm.id,
          itemTitle: deleteConfirm.title,
          success: false,
          error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
        }
      })
    } finally {
      setDeleteConfirm(null)
    }
  }

  // å¼€å§‹å­¦ä¹ è¯¾ç¨‹å•å…ƒ
  const startLearning = async (unitId: string) => {
    try {
      const result = startCourseUnit(unitId)
      if (result) {
        setMessage(`âœ… å¼€å§‹å­¦ä¹ : ${result.title}`)
        refreshData()
      } else {
        setMessage(`âŒ æ— æ³•å¼€å§‹å­¦ä¹ è¯¥è¯¾ç¨‹å•å…ƒ`)
      }
    } catch (error) {
      setMessage(`âŒ å¼€å§‹å­¦ä¹ å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // æ ‡è®°ç« èŠ‚å®Œæˆ
  const completeSection = async (unitId: string, section: 'reading' | 'practice' | 'summary', timeSpent: number = 0) => {
    try {
      const result = markSectionComplete(unitId, section, timeSpent)
      if (result) {
        setMessage(`âœ… ${section === 'reading' ? 'é˜…è¯»' : section === 'practice' ? 'ç»ƒä¹ ' : 'æ€»ç»“'}éƒ¨åˆ†å·²å®Œæˆ`)
        refreshData()
      } else {
        setMessage(`âŒ æ— æ³•å®Œæˆè¯¥ç« èŠ‚`)
      }
    } catch (error) {
      setMessage(`âŒ å®Œæˆç« èŠ‚å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // åˆ›å»ºæ–°çš„è¯¾ç¨‹å•å…ƒ
  const createNewCourseUnit = async (nodeId: string) => {
    if (!nodeId) {
      setMessage(`âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè·¯å¾„èŠ‚ç‚¹`)
      return
    }
    
    try {
      setLoading(true)
      
      // è·å–èŠ‚ç‚¹ç°æœ‰çš„è¯¾ç¨‹å•å…ƒæ•°é‡ï¼Œç”¨äºæ’åº
      const existingUnits = getCourseUnitsByNode(nodeId)
      const order = existingUnits.length + 1
      
      const newUnit = createCourseUnit({
        nodeId: nodeId,
        title: `æ–°è¯¾ç¨‹å•å…ƒ ${order}`,
        description: 'è¯·ç¼–è¾‘æ­¤è¯¾ç¨‹å•å…ƒçš„è¯¦ç»†ä¿¡æ¯',
        type: 'theory',
        content: {
          reading: {
            markdown: '# è¯¾ç¨‹å†…å®¹\n\nè¯·åœ¨æ­¤å¤„æ·»åŠ è¯¾ç¨‹çš„é˜…è¯»å†…å®¹...',
            estimatedTime: 30,
            keyPoints: ['å…³é”®ç‚¹1', 'å…³é”®ç‚¹2'],
            resources: []
          },
          practice: {
            exercises: [],
            totalEstimatedTime: 20
          },
          summary: {
            markdown: '## è¯¾ç¨‹æ€»ç»“\n\nè¯·åœ¨æ­¤å¤„æ·»åŠ è¯¾ç¨‹æ€»ç»“...',
            keyTakeaways: ['è¦ç‚¹1', 'è¦ç‚¹2'],
            nextSteps: ['ä¸‹ä¸€æ­¥1', 'ä¸‹ä¸€æ­¥2'],
            relatedTopics: ['ç›¸å…³ä¸»é¢˜1', 'ç›¸å…³ä¸»é¢˜2']
          }
        },
        metadata: {
          difficulty: 3,
          estimatedTime: 50,
          keywords: ['æ–°è¯¾ç¨‹'],
          learningObjectives: ['å­¦ä¼šæ–°æŠ€èƒ½'],
          prerequisites: [],
          order: order
        }
      })

      setMessage(`âœ… æˆåŠŸåˆ›å»ºè¯¾ç¨‹å•å…ƒ: ${newUnit.title}`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ åˆ›å»ºè¯¾ç¨‹å•å…ƒå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    } finally {
      setLoading(false)
    }
  }

  // è·å–èŠ‚ç‚¹çš„è¯¾ç¨‹å•å…ƒ
  const getNodeUnits = (nodeId: string) => {
    return getCourseUnitsByNode(nodeId)
  }

  // è·å–èŠ‚ç‚¹å­¦ä¹ ç»Ÿè®¡
  const getNodeStats = (nodeId: string) => {
    return getNodeLearningStats(nodeId)
  }

  // ========== å…³è”ç®¡ç†åŠŸèƒ½ ==========
  
  // å…³è”è·¯å¾„åˆ°ç›®æ ‡
  const linkPath = async (goalId: string, pathId: string) => {
    try {
      const result = linkPathToGoal(goalId, pathId)
      if (result) {
        setMessage(`âœ… æˆåŠŸå…³è”è·¯å¾„åˆ°ç›®æ ‡`)
        refreshData()
      } else {
        setMessage(`âŒ å…³è”å¤±è´¥`)
      }
    } catch (error) {
      setMessage(`âŒ å…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // å…³è”è¯¾ç¨‹å†…å®¹åˆ°èŠ‚ç‚¹
  const linkCourseUnit = async (pathId: string, nodeId: string, courseUnitId: string) => {
    try {
      const result = linkCourseUnitToNode(pathId, nodeId, courseUnitId)
      if (result) {
        setMessage(`âœ… æˆåŠŸå…³è”è¯¾ç¨‹å†…å®¹åˆ°èŠ‚ç‚¹`)
        refreshData()
      } else {
        setMessage(`âŒ å…³è”å¤±è´¥`)
      }
    } catch (error) {
      setMessage(`âŒ å…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // ç§»é™¤å…³è”
  const unlinkPath = async (goalId: string, pathId: string) => {
    try {
      const result = unlinkPathFromGoal(goalId, pathId)
      if (result) {
        setMessage(`âœ… æˆåŠŸç§»é™¤è·¯å¾„ä¸ç›®æ ‡çš„å…³è”`)
        refreshData()
      } else {
        setMessage(`âŒ ç§»é™¤å…³è”å¤±è´¥`)
      }
    } catch (error) {
      setMessage(`âŒ ç§»é™¤å…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  const unlinkUnit = async (pathId: string, nodeId: string, courseUnitId: string) => {
    try {
      const result = unlinkCourseUnitFromNode(pathId, nodeId, courseUnitId)
      if (result) {
        setMessage(`âœ… æˆåŠŸç§»é™¤è¯¾ç¨‹å†…å®¹ä¸èŠ‚ç‚¹çš„å…³è”`)
        refreshData()
      } else {
        setMessage(`âŒ ç§»é™¤å…³è”å¤±è´¥`)
      }
    } catch (error) {
      setMessage(`âŒ ç§»é™¤å…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // åŒæ­¥å…³è”å…³ç³»
  const syncRelationships = async () => {
    try {
      const result = syncDataRelationships()
      setMessage(`âœ… åŒæ­¥å®Œæˆ: ${result.removedLinks.length > 0 ? 
        `æ¸…ç†äº† ${result.removedLinks.length} ä¸ªæ— æ•ˆå…³è”` : 
        'æ•°æ®å…³è”å…³ç³»æ­£å¸¸'}`)
      refreshData()
    } catch (error) {
      setMessage(`âŒ åŒæ­¥å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  // ä½¿ç”¨Agentå·¥å…·æ‰§è¡Œå…³è”æ“ä½œ
  const linkPathWithAgent = async () => {
    if (!selectedGoalForLink || !selectedPathForLink) {
      setMessage('âŒ è¯·é€‰æ‹©ç›®æ ‡å’Œè·¯å¾„')
      return
    }

    try {
      await agentToolExecutor.executeTool('link_path_to_goal', {
        goalId: selectedGoalForLink,
        pathId: selectedPathForLink
      })
      setMessage(`âœ… é€šè¿‡AgentæˆåŠŸå…³è”è·¯å¾„åˆ°ç›®æ ‡`)
      setSelectedGoalForLink(null)
      setSelectedPathForLink(null)
      refreshData()
    } catch (error) {
      setMessage(`âŒ Agentå…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  const linkUnitWithAgent = async () => {
    if (!selectedPathForLink || !selectedNodeForLink || !selectedUnitForLink) {
      setMessage('âŒ è¯·é€‰æ‹©è·¯å¾„ã€èŠ‚ç‚¹å’Œè¯¾ç¨‹å†…å®¹')
      return
    }

    try {
      await agentToolExecutor.executeTool('link_courseunit_to_node', {
        pathId: selectedPathForLink,
        nodeId: selectedNodeForLink,
        courseUnitId: selectedUnitForLink
      })
      setMessage(`âœ… é€šè¿‡AgentæˆåŠŸå…³è”è¯¾ç¨‹å†…å®¹åˆ°èŠ‚ç‚¹`)
      setSelectedPathForLink(null)
      setSelectedNodeForLink(null)
      setSelectedUnitForLink(null)
      refreshData()
    } catch (error) {
      setMessage(`âŒ Agentå…³è”å¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`)
    }
  }

  return (
    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      <div style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        marginBottom: '20px'
      }}>
        <h1>ğŸ—‚ï¸ æ•°æ®ç®¡ç†</h1>
        <div style={{ display: 'flex', gap: '10px' }}>
          <button
            onClick={createNewGoal}
            disabled={loading}
            style={{
              padding: '10px 20px',
              backgroundColor: '#4CAF50',
              color: 'white',
              border: 'none',
              borderRadius: '5px',
              cursor: loading ? 'not-allowed' : 'pointer',
              opacity: loading ? 0.6 : 1
            }}
          >
            â• æ–°å»ºç›®æ ‡
          </button>
          <button
            onClick={refreshData}
            style={{
              padding: '10px 20px',
              backgroundColor: '#2196F3',
              color: 'white',
              border: 'none',
              borderRadius: '5px',
              cursor: 'pointer'
            }}
          >
            ğŸ”„ åˆ·æ–°æ•°æ®
          </button>
        </div>
      </div>

      {/* æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ */}
      {message && (
        <div style={{
          padding: '10px 15px',
          marginBottom: '20px',
          backgroundColor: message.includes('âœ…') ? '#d1ecf1' : '#f8d7da',
          border: `1px solid ${message.includes('âœ…') ? '#bee5eb' : '#f5c6cb'}`,
          borderRadius: '8px',
          color: message.includes('âœ…') ? '#0c5460' : '#721c24'
        }}>
          {message}
        </div>
      )}

      {/* æ“ä½œæç¤º */}
      <div style={{
        padding: '15px',
        backgroundColor: '#e3f2fd',
        borderRadius: '8px',
        border: '1px solid #bbdefb',
        marginBottom: '20px'
      }}>
        <h4 style={{ margin: '0 0 10px 0', color: '#1976d2' }}>ğŸ’¡ çŠ¶æ€ç®¡ç†æ“ä½œæŒ‡å—</h4>
        <div style={{ fontSize: '14px', lineHeight: '1.6' }}>
          <p><strong>ğŸ¯ ç›®æ ‡æ“ä½œï¼š</strong>ç‚¹å‡»ç›®æ ‡å¡ç‰‡å±•å¼€æ“ä½œæŒ‰é’®ï¼Œæ”¯æŒæš‚åœã€å®Œæˆã€å–æ¶ˆã€é‡æ–°æ¿€æ´»ç­‰æ“ä½œ</p>
          <p><strong>ğŸ›¤ï¸ è·¯å¾„æ“ä½œï¼š</strong>æ¯ä¸ªè·¯å¾„éƒ½æœ‰å¯¹åº”çš„çŠ¶æ€ç®¡ç†æŒ‰é’®ï¼Œå¯ä»¥çµæ´»æ§åˆ¶å­¦ä¹ è¿›åº¦</p>
          <p><strong>ğŸ”„ æ™ºèƒ½åŒæ­¥ï¼š</strong>ç›®æ ‡çŠ¶æ€å˜åŒ–ä¼šè‡ªåŠ¨åŒæ­¥ç›¸å…³è·¯å¾„ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§</p>
          <p><strong>ğŸ“Š å®æ—¶åé¦ˆï¼š</strong>æ‰€æœ‰æ“ä½œéƒ½ä¼šæ˜¾ç¤ºç»“æœæ¶ˆæ¯ï¼Œå¹¶æ›´æ–°æ•°æ®ç»Ÿè®¡</p>
        </div>
      </div>

      {loading && (
        <div style={{
          padding: '20px',
          textAlign: 'center',
          backgroundColor: '#f0f0f0',
          borderRadius: '5px',
          marginBottom: '20px'
        }}>
          â³ å¤„ç†ä¸­...
        </div>
      )}

      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: '1fr 1fr', 
        gap: '20px',
        marginBottom: '20px'
      }}>
        {/* å®æ—¶æ•°æ®ç»Ÿè®¡ */}
        <div style={{
          padding: '15px',
          backgroundColor: '#e3f2fd',
          borderRadius: '8px',
          border: '1px solid #bbdefb'
        }}>
          <h3 style={{ margin: '0 0 15px 0', color: '#1976d2' }}>ğŸ“Š å®æ—¶æ•°æ®ç»Ÿè®¡</h3>
          {coreData && (
            <div style={{ fontSize: '14px', lineHeight: '1.6' }}>
              <p><strong>å­¦ä¹ ç›®æ ‡ï¼š</strong> {coreData.goals.length} ä¸ª</p>
              <p><strong>å­¦ä¹ è·¯å¾„ï¼š</strong> {coreData.paths.length} ä¸ª</p>
              <p><strong>è¯¾ç¨‹å•å…ƒï¼š</strong> {coreData.courseUnits.length} ä¸ª</p>
              <p><strong>AIåŠ¨ä½œè®°å½•ï¼š</strong> {coreData.agentActions.length} ä¸ª</p>
              <p><strong>èƒ½åŠ›è¯„ä¼°ï¼š</strong> {coreData.currentAssessment ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}</p>
              
              {coreData.goals.length > 0 && (
                <div style={{ marginTop: '10px' }}>
                  <strong>ç›®æ ‡çŠ¶æ€åˆ†å¸ƒï¼š</strong>
                  <ul style={{ margin: '5px 0', paddingLeft: '20px' }}>
                    {['active', 'completed', 'paused', 'cancelled'].map(status => {
                      const count = coreData.goals.filter((g: any) => g.status === status).length
                      return count > 0 ? <li key={status}>{status}: {count}</li> : null
                    })}
                  </ul>
                </div>
              )}

              {coreData.paths.length > 0 && (
                <div style={{ marginTop: '10px' }}>
                  <strong>è·¯å¾„çŠ¶æ€åˆ†å¸ƒï¼š</strong>
                  <ul style={{ margin: '5px 0', paddingLeft: '20px' }}>
                    {['active', 'completed', 'archived', 'frozen', 'paused', 'draft'].map(status => {
                      const count = coreData.paths.filter((p: any) => p.status === status).length
                      return count > 0 ? <li key={status}>{status}: {count}</li> : null
                    })}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Profileä¿¡æ¯ */}
        <div style={{
          padding: '15px',
          backgroundColor: '#f3e5f5',
          borderRadius: '8px',
          border: '1px solid #ce93d8'
        }}>
          <h3 style={{ margin: '0 0 15px 0', color: '#7b1fa2' }}>ğŸ‘¤ Profileä¿¡æ¯</h3>
          {profileData && (
            <div style={{ fontSize: '14px', lineHeight: '1.6' }}>
              <p><strong>ç”¨æˆ·åï¼š</strong> {profileData.profile.name}</p>
              <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong> {new Date(profileData.profile.createdAt).toLocaleString()}</p>
              <p><strong>æ˜¯å¦åŠ å¯†ï¼š</strong> {profileData.profile.isEncrypted ? 'æ˜¯' : 'å¦'}</p>
              <p><strong>æ•°æ®ç‰ˆæœ¬ï¼š</strong> {profileData.coreData?.metadata?.version || 'æœªçŸ¥'}</p>
              <p><strong>æœ€åæ›´æ–°ï¼š</strong> {profileData.coreData?.metadata?.lastUpdated ? 
                new Date(profileData.coreData.metadata.lastUpdated).toLocaleString() : 'æœªçŸ¥'}</p>
              <p><strong>æ€»å­¦ä¹ æ—¶é—´ï¼š</strong> {profileData.coreData?.metadata?.totalStudyTime || 0} åˆ†é’Ÿ</p>
            </div>
          )}
        </div>
      </div>

      {/* ç›®æ ‡çŠ¶æ€ç»Ÿè®¡å¡ç‰‡ */}
      {goalStats && (
        <div style={{
          padding: '20px',
          backgroundColor: '#f8f9fa',
          borderRadius: '8px',
          marginBottom: '20px',
          border: '1px solid #dee2e6'
        }}>
          <h3 style={{ margin: '0 0 15px 0', display: 'flex', alignItems: 'center', gap: '8px' }}>
            ğŸ“Š ç›®æ ‡çŠ¶æ€ç»Ÿè®¡
            {!goalStats.canActivateMore && (
              <span style={{
                padding: '4px 8px',
                backgroundColor: '#ff6b6b',
                color: 'white',
                borderRadius: '12px',
                fontSize: '12px',
                fontWeight: 'normal'
              }}>
                å·²è¾¾ä¸Šé™
              </span>
            )}
          </h3>
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', 
            gap: '15px' 
          }}>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>
                {goalStats.active}
              </div>
              <div style={{ fontSize: '12px', color: '#666' }}>æ¿€æ´»ä¸­</div>
              <div style={{ fontSize: '10px', color: '#999' }}>æœ€å¤š3ä¸ª</div>
            </div>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2196F3' }}>
                {goalStats.completed}
              </div>
              <div style={{ fontSize: '12px', color: '#666' }}>å·²å®Œæˆ</div>
            </div>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF9800' }}>
                {goalStats.paused}
              </div>
              <div style={{ fontSize: '12px', color: '#666' }}>å·²æš‚åœ</div>
            </div>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f44336' }}>
                {goalStats.cancelled}
              </div>
              <div style={{ fontSize: '12px', color: '#666' }}>å·²å–æ¶ˆ</div>
            </div>
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#6c757d' }}>
                {goalStats.total}
              </div>
              <div style={{ fontSize: '12px', color: '#666' }}>æ€»è®¡</div>
            </div>
          </div>
          
          {/* æ¿€æ´»é™åˆ¶æé†’ */}
          {!goalStats.canActivateMore && (
            <div style={{
              marginTop: '15px',
              padding: '10px',
              backgroundColor: '#fff3cd',
              border: '1px solid #ffeaa7',
              borderRadius: '5px',
              color: '#856404'
            }}>
              <strong>âš ï¸ æé†’ï¼š</strong> æ‚¨å·²æ¿€æ´»3ä¸ªç›®æ ‡ï¼ˆä¸Šé™ï¼‰ã€‚è¦æ¿€æ´»æ–°ç›®æ ‡ï¼Œè¯·å…ˆæš‚åœæˆ–å®Œæˆç°æœ‰ç›®æ ‡ã€‚
            </div>
          )}
          
          {goalStats.canActivateMore && goalStats.active > 0 && (
            <div style={{
              marginTop: '15px',
              padding: '10px',
              backgroundColor: '#d1ecf1',
              border: '1px solid #bee5eb',
              borderRadius: '5px',
              color: '#0c5460'
            }}>
              <strong>ğŸ’¡ æç¤ºï¼š</strong> æ‚¨è¿˜å¯ä»¥æ¿€æ´» {3 - goalStats.active} ä¸ªç›®æ ‡ã€‚
            </div>
          )}
        </div>
      )}

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '20px', marginBottom: '20px' }}>
        {/* å­¦ä¹ ç›®æ ‡ç®¡ç† */}
        <div>
          <h2>ğŸ“‹ å­¦ä¹ ç›®æ ‡ç®¡ç† ({goals.length})</h2>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
            {goals.map((goal) => (
              <div
                key={goal.id}
                style={{
                  padding: '15px',
                  border: `2px solid ${selectedGoal === goal.id ? '#007bff' : '#ddd'}`,
                  borderRadius: '8px',
                  backgroundColor: selectedGoal === goal.id ? '#f8f9fa' : 'white',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onClick={() => setSelectedGoal(selectedGoal === goal.id ? null : goal.id)}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h3 style={{ margin: '0 0 5px 0', fontSize: '16px' }}>{goal.title}</h3>
                  <span
                    style={{
                      padding: '3px 8px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      color: 'white',
                      backgroundColor: getStatusColor(goal.status)
                    }}
                  >
                    {getStatusText(goal.status)}
                  </span>
                </div>
                <p style={{ margin: '5px 0', fontSize: '14px', color: '#666' }}>
                  {goal.description}
                </p>
                <div style={{ fontSize: '12px', color: '#888' }}>
                  ğŸ“‚ {goal.category} | â±ï¸ {goal.estimatedTimeWeeks}å‘¨ | ğŸ“ˆ {goal.targetLevel}
                </div>
                
                {selectedGoal === goal.id && (
                  <div style={{ 
                    marginTop: '10px', 
                    paddingTop: '10px', 
                    borderTop: '1px solid #eee',
                    display: 'flex',
                    gap: '5px',
                    flexWrap: 'wrap'
                  }}>
                    {goal.status === 'active' && (
                      <>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            generatePathForGoal(goal.id)
                          }}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#28a745',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ›¤ï¸ ç”Ÿæˆè·¯å¾„
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            updateGoalStatus(goal.id, 'paused')
                          }}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#ffc107',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          â¸ï¸ æš‚åœ
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            updateGoalStatus(goal.id, 'completed')
                          }}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#007bff',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          âœ… å®Œæˆ
                        </button>
                      </>
                    )}
                    {goal.status === 'paused' && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          updateGoalStatus(goal.id, 'active')
                        }}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#28a745',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        â–¶ï¸ æ¢å¤
                      </button>
                    )}
                    {goal.status === 'completed' && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          updateGoalStatus(goal.id, 'active')
                        }}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#17a2b8',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        ğŸ”„ é‡æ–°å¼€å§‹
                      </button>
                    )}
                    {['active', 'paused'].includes(goal.status) && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          updateGoalStatus(goal.id, 'cancelled')
                        }}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#f44336',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        âŒ å–æ¶ˆ
                      </button>
                    )}
                    {goal.status === 'cancelled' && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          updateGoalStatus(goal.id, 'active')
                        }}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#28a745',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        ğŸ”„ é‡æ–°æ¿€æ´»
                      </button>
                    )}
                    <button
                      onClick={(e) => {
                        e.stopPropagation()
                        handleDelete('goal', goal.id, goal.title)
                      }}
                      style={{
                        padding: '5px 10px',
                        backgroundColor: '#dc3545',
                        color: 'white',
                        border: 'none',
                        borderRadius: '3px',
                        fontSize: '12px',
                        cursor: 'pointer'
                      }}
                    >
                      ğŸ—‘ï¸ åˆ é™¤
                    </button>
                  </div>
                )}
              </div>
            ))}
            
            {goals.length === 0 && (
              <div style={{
                padding: '40px',
                textAlign: 'center',
                color: '#888',
                backgroundColor: '#f9f9f9',
                borderRadius: '8px',
                border: '2px dashed #ddd'
              }}>
                <div style={{ fontSize: '48px', marginBottom: '10px' }}>ğŸ¯</div>
                <p>è¿˜æ²¡æœ‰å­¦ä¹ ç›®æ ‡</p>
                <p style={{ fontSize: '14px' }}>ç‚¹å‡»"æ–°å»ºç›®æ ‡"å¼€å§‹æ‚¨çš„å­¦ä¹ ä¹‹æ—…</p>
              </div>
            )}
          </div>
        </div>

        {/* å­¦ä¹ è·¯å¾„ç®¡ç† */}
        <div>
          <h2>ğŸ›¤ï¸ å­¦ä¹ è·¯å¾„ç®¡ç† ({paths.length})</h2>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
            {paths.map((path) => {
              const relatedGoal = goals.find(g => g.id === path.goalId)
              const completedNodes = path.nodes.filter(n => n.status === 'completed')
              const progress = path.nodes.length > 0 ? 
                (completedNodes.length / path.nodes.length) * 100 : 0

              return (
                <div
                  key={path.id}
                  style={{
                    padding: '15px',
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    backgroundColor: 'white'
                  }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{ margin: '0 0 5px 0', fontSize: '16px' }}>{path.title}</h3>
                    <span
                      style={{
                        padding: '3px 8px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        color: 'white',
                        backgroundColor: getStatusColor(path.status)
                      }}
                    >
                      {getStatusText(path.status)}
                    </span>
                  </div>
                  
                  {relatedGoal && (
                    <div style={{ 
                      fontSize: '12px', 
                      color: '#666',
                      marginBottom: '10px'
                    }}>
                      ğŸ“‹ ç›®æ ‡: {relatedGoal.title}
                    </div>
                  )}

                  <p style={{ margin: '5px 0', fontSize: '14px', color: '#666' }}>
                    {path.description}
                  </p>

                  {/* è¿›åº¦æ¡ */}
                  <div style={{ marginTop: '10px' }}>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      marginBottom: '5px'
                    }}>
                      <span style={{ fontSize: '12px', color: '#888' }}>
                        è¿›åº¦: {completedNodes.length}/{path.nodes.length} èŠ‚ç‚¹
                      </span>
                      <span style={{ fontSize: '12px', color: '#888' }}>
                        {Math.round(progress)}%
                      </span>
                    </div>
                    <div style={{
                      width: '100%',
                      height: '6px',
                      backgroundColor: '#e9ecef',
                      borderRadius: '3px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${progress}%`,
                        height: '100%',
                        backgroundColor: progress > 80 ? '#28a745' : 
                                      progress > 50 ? '#ffc107' : '#007bff',
                        transition: 'width 0.3s ease'
                      }} />
                    </div>
                  </div>

                  <div style={{ 
                    fontSize: '12px', 
                    color: '#888',
                    marginTop: '8px'
                  }}>
                    â±ï¸ é¢„è®¡ {path.totalEstimatedHours}å°æ—¶ | ğŸ†” {path.id}
                  </div>

                  {/* è·¯å¾„èŠ‚ç‚¹é¢„è§ˆ */}
                  {path.nodes.length > 0 && (
                    <div style={{ marginTop: '10px' }}>
                      <details>
                        <summary style={{ cursor: 'pointer', fontSize: '12px', color: '#007bff' }}>
                          ğŸ“š æŸ¥çœ‹èŠ‚ç‚¹ ({path.nodes.length}ä¸ª)
                        </summary>
                        <div style={{ marginTop: '8px', paddingLeft: '10px' }}>
                          {path.nodes.slice(0, 5).map((node, index) => (
                            <div key={node.id} style={{
                              fontSize: '11px',
                              padding: '2px 0',
                              color: node.status === 'completed' ? '#28a745' : 
                                    node.status === 'in_progress' ? '#ffc107' : '#6c757d'
                            }}>
                              {index + 1}. {node.title} ({node.estimatedHours}h)
                              {node.status === 'completed' && ' âœ…'}
                              {node.status === 'in_progress' && ' ğŸ”„'}
                            </div>
                          ))}
                          {path.nodes.length > 5 && (
                            <div style={{ fontSize: '11px', color: '#888' }}>
                              ... è¿˜æœ‰ {path.nodes.length - 5} ä¸ªèŠ‚ç‚¹
                            </div>
                          )}
                        </div>
                      </details>
                    </div>
                  )}

                  {/* è·¯å¾„æ“ä½œæŒ‰é’® */}
                  <div style={{ 
                    marginTop: '10px', 
                    display: 'flex', 
                    gap: '5px',
                    flexWrap: 'wrap'
                  }}>
                    {/* æ¿€æ´»çŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'active' && (
                      <>
                        <button
                          onClick={() => pausePath(path.id)}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#ffc107',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          â¸ï¸ æš‚åœ
                        </button>
                        <button
                          onClick={() => completePath(path.id)}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#007bff',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          âœ… å®Œæˆ
                        </button>
                        <button
                          onClick={() => updatePathStatus(path.id, 'archived')}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ“¦ å½’æ¡£
                        </button>
                      </>
                    )}

                    {/* æš‚åœçŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'paused' && (
                      <>
                        <button
                          onClick={() => resumePath(path.id)}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#28a745',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          â–¶ï¸ æ¢å¤
                        </button>
                        <button
                          onClick={() => completePath(path.id)}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#007bff',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          âœ… å®Œæˆ
                        </button>
                        <button
                          onClick={() => updatePathStatus(path.id, 'archived')}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ“¦ å½’æ¡£
                        </button>
                      </>
                    )}

                    {/* å†»ç»“çŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'frozen' && (
                      <>
                        <button
                          onClick={() => activateFrozenPath(path.id)}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#28a745',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ”¥ æ¿€æ´»
                        </button>
                        <button
                          onClick={() => updatePathStatus(path.id, 'archived')}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ“¦ å½’æ¡£
                        </button>
                      </>
                    )}

                    {/* è‰ç¨¿çŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'draft' && (
                      <>
                        <button
                          onClick={() => updatePathStatus(path.id, 'active')}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#28a745',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸš€ å¯åŠ¨
                        </button>
                        <button
                          onClick={() => updatePathStatus(path.id, 'archived')}
                          style={{
                            padding: '5px 10px',
                            backgroundColor: '#6c757d',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          ğŸ“¦ å½’æ¡£
                        </button>
                      </>
                    )}

                    {/* å·²å½’æ¡£çŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'archived' && (
                      <button
                        onClick={() => updatePathStatus(path.id, 'active')}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#17a2b8',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        ğŸ”„ é‡æ–°æ¿€æ´»
                      </button>
                    )}

                    {/* å·²å®ŒæˆçŠ¶æ€çš„è·¯å¾„æ“ä½œ */}
                    {path.status === 'completed' && (
                      <button
                        onClick={() => updatePathStatus(path.id, 'active')}
                        style={{
                          padding: '5px 10px',
                          backgroundColor: '#17a2b8',
                          color: 'white',
                          border: 'none',
                          borderRadius: '3px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        ğŸ”„ é‡æ–°å¼€å§‹
                      </button>
                    )}

                    {/* é€šç”¨åˆ é™¤æŒ‰é’® */}
                    <button
                      onClick={() => handleDelete('path', path.id, path.title)}
                      style={{
                        padding: '5px 10px',
                        backgroundColor: '#dc3545',
                        color: 'white',
                        border: 'none',
                        borderRadius: '3px',
                        fontSize: '12px',
                        cursor: 'pointer'
                      }}
                    >
                      ğŸ—‘ï¸ åˆ é™¤
                    </button>
                  </div>
                </div>
              )
            })}

            {paths.length === 0 && (
              <div style={{
                padding: '40px',
                textAlign: 'center',
                color: '#888',
                backgroundColor: '#f9f9f9',
                borderRadius: '8px',
                border: '2px dashed #ddd'
              }}>
                <div style={{ fontSize: '48px', marginBottom: '10px' }}>ğŸ›¤ï¸</div>
                <p>è¿˜æ²¡æœ‰å­¦ä¹ è·¯å¾„</p>
                <p style={{ fontSize: '14px' }}>å…ˆåˆ›å»ºå­¦ä¹ ç›®æ ‡ï¼Œç„¶åç”Ÿæˆå­¦ä¹ è·¯å¾„</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* æ•°æ®ç®¡ç†åŒºåŸŸ */}
      <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
        {/* è¯¾ç¨‹å†…å®¹ç®¡ç† */}
        <div style={{
          padding: '20px',
          backgroundColor: '#ffffff',
          borderRadius: '8px',
          border: '1px solid #ddd'
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, color: '#333' }}>ğŸ“š è¯¾ç¨‹å†…å®¹ç®¡ç†</h3>
            <div style={{ display: 'flex', gap: '10px' }}>
              <button
                onClick={() => {
                  setShowCourseManagement(!showCourseManagement)
                  setShowRelationshipManagement(false)
                }}
                style={{
                  padding: '10px 20px',
                  backgroundColor: showCourseManagement ? '#28a745' : '#6c757d',
                  color: 'white',
                  border: 'none',
                  borderRadius: '5px',
                  cursor: 'pointer',
                  fontSize: '14px'
                }}
              >
                {showCourseManagement ? 'ğŸ“š éšè—è¯¾ç¨‹ç®¡ç†' : 'ğŸ“š æ˜¾ç¤ºè¯¾ç¨‹ç®¡ç†'}
              </button>
            </div>
          </div>

          {showCourseManagement && (
            <div>
              {/* èŠ‚ç‚¹é€‰æ‹©å™¨ */}
              <div style={{ marginBottom: '20px' }}>
                <h4 style={{ marginBottom: '10px', color: '#495057' }}>ğŸ¯ é€‰æ‹©å­¦ä¹ èŠ‚ç‚¹</h4>
                <select
                  value={selectedNode || ''}
                  onChange={(e) => setSelectedNode(e.target.value || null)}
                  style={{
                    padding: '8px 12px',
                    border: '1px solid #ced4da',
                    borderRadius: '4px',
                    fontSize: '14px',
                    width: '300px'
                  }}
                >
                  <option value="">-- é€‰æ‹©èŠ‚ç‚¹ --</option>
                  {paths.flatMap(path => 
                    path.nodes.map(node => (
                      <option key={node.id} value={node.id}>
                        {path.title} - {node.title}
                      </option>
                    ))
                  )}
                </select>
                {selectedNode && (
                  <button
                    onClick={() => createNewCourseUnit(selectedNode)}
                    style={{
                      marginLeft: '10px',
                      padding: '8px 16px',
                      backgroundColor: '#007bff',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '14px'
                    }}
                  >
                    â• åˆ›å»ºè¯¾ç¨‹å•å…ƒ
                  </button>
                )}
              </div>

              {/* é€‰ä¸­èŠ‚ç‚¹çš„ç»Ÿè®¡ä¿¡æ¯ */}
              {selectedNode && (
                <div style={{
                  padding: '15px',
                  backgroundColor: '#e3f2fd',
                  borderRadius: '8px',
                  marginBottom: '20px',
                  border: '1px solid #bbdefb'
                }}>
                  <h4 style={{ margin: '0 0 10px 0', color: '#1976d2' }}>ğŸ“ˆ èŠ‚ç‚¹å­¦ä¹ ç»Ÿè®¡</h4>
                  {(() => {
                    const stats = getNodeStats(selectedNode)
                    return (
                      <div style={{ display: 'flex', gap: '20px', fontSize: '14px' }}>
                        <span><strong>è¯¾ç¨‹å•å…ƒï¼š</strong> {stats.totalUnits} ä¸ª</span>
                        <span><strong>å®Œæˆè¿›åº¦ï¼š</strong> {stats.progress}%</span>
                        <span><strong>å­¦ä¹ æ—¶é•¿ï¼š</strong> {Math.round(stats.totalTime)} åˆ†é’Ÿ</span>
                        <span><strong>é¢„è®¡æ—¶é•¿ï¼š</strong> {stats.estimatedTime} åˆ†é’Ÿ</span>
                      </div>
                    )
                  })()}
                </div>
              )}

              {/* è¯¾ç¨‹å•å…ƒåˆ—è¡¨ */}
              <div style={{ marginBottom: '20px' }}>
                <h4 style={{ marginBottom: '15px', color: '#495057' }}>
                  ğŸ“‹ è¯¾ç¨‹å•å…ƒ ({selectedNode ? getNodeUnits(selectedNode).length : courseUnits.length} ä¸ª)
                </h4>
                
                {(selectedNode ? getNodeUnits(selectedNode) : courseUnits).map((unit: CourseUnit) => (
                  <div key={unit.id} style={{
                    border: '1px solid #dee2e6',
                    borderRadius: '8px',
                    padding: '15px',
                    marginBottom: '15px',
                    backgroundColor: '#ffffff'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                      <div>
                        <h5 style={{ margin: '0 0 5px 0', color: '#333' }}>{unit.title}</h5>
                        <div style={{ fontSize: '13px', color: '#666', marginBottom: '5px' }}>
                          {unit.description}
                        </div>
                        <div style={{ fontSize: '12px', color: '#999' }}>
                          ç±»å‹: {unit.type} | éš¾åº¦: {unit.metadata.difficulty}/5 | 
                          é¢„è®¡: {unit.metadata.estimatedTime}min | æ’åº: {unit.metadata.order}
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '5px' }}>
                        <button
                          onClick={() => setSelectedUnit(unit)}
                          style={{
                            padding: '4px 8px',
                            backgroundColor: '#17a2b8',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          ğŸ“ è¯¦æƒ…
                        </button>
                        <button
                          onClick={() => handleDelete('unit', unit.id, unit.title)}
                          style={{
                            padding: '4px 8px',
                            backgroundColor: '#dc3545',
                            color: 'white',
                            border: 'none',
                            borderRadius: '3px',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          ğŸ—‘ï¸ åˆ é™¤
                        </button>
                      </div>
                    </div>

                    {/* è¿›åº¦æ¡ */}
                    <div style={{ marginBottom: '10px' }}>
                      <div style={{ 
                        display: 'flex', 
                        justifyContent: 'space-between', 
                        alignItems: 'center',
                        marginBottom: '5px'
                      }}>
                        <span style={{ fontSize: '12px', fontWeight: 'bold' }}>
                          å­¦ä¹ è¿›åº¦: {unit.progress?.overallProgress || 0}%
                        </span>
                        <span style={{ 
                          fontSize: '11px', 
                          padding: '2px 6px',
                          borderRadius: '10px',
                          backgroundColor: unit.progress?.status === 'completed' ? '#28a745' : 
                                          unit.progress?.status === 'not_started' ? '#6c757d' : '#ffc107',
                          color: 'white'
                        }}>
                          {unit.progress?.status === 'not_started' ? 'æœªå¼€å§‹' :
                           unit.progress?.status === 'reading' ? 'é˜…è¯»ä¸­' :
                           unit.progress?.status === 'practicing' ? 'ç»ƒä¹ ä¸­' :
                           unit.progress?.status === 'summarizing' ? 'æ€»ç»“ä¸­' : 'å·²å®Œæˆ'}
                        </span>
                      </div>
                      <div style={{
                        width: '100%',
                        height: '6px',
                        backgroundColor: '#e9ecef',
                        borderRadius: '3px',
                        overflow: 'hidden'
                      }}>
                        <div style={{
                          width: `${unit.progress?.overallProgress || 0}%`,
                          height: '100%',
                          backgroundColor: '#28a745',
                          transition: 'width 0.3s ease'
                        }} />
                      </div>
                    </div>

                    {/* ç« èŠ‚çŠ¶æ€ */}
                    <div style={{ display: 'flex', gap: '10px', fontSize: '12px' }}>
                      <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '4px',
                        color: unit.progress?.sections?.reading?.completed ? '#28a745' : '#6c757d'
                      }}>
                        {unit.progress?.sections?.reading?.completed ? 'âœ…' : 'ğŸ“–'} 
                        é˜…è¯» ({unit.progress?.sections?.reading?.timeSpent}min)
                      </div>
                      <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '4px',
                        color: unit.progress?.sections?.practice?.completed ? '#28a745' : '#6c757d'
                      }}>
                        {unit.progress?.sections?.practice?.completed ? 'âœ…' : 'ğŸ’»'} 
                        ç»ƒä¹  ({unit.progress?.sections?.practice?.timeSpent}min)
                      </div>
                      <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '4px',
                        color: unit.progress?.sections?.summary?.completed ? '#28a745' : '#6c757d'
                      }}>
                        {unit.progress?.sections?.summary?.completed ? 'âœ…' : 'ğŸ“'} 
                        æ€»ç»“ ({unit.progress?.sections?.summary?.timeSpent}min)
                      </div>
                    </div>

                    {/* æ“ä½œæŒ‰é’® */}
                    {unit.progress?.status !== 'completed' && (
                      <div style={{ marginTop: '10px', display: 'flex', gap: '8px' }}>
                        {unit.progress?.status === 'not_started' && (
                          <button
                            onClick={() => startLearning(unit.id)}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#007bff',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '12px'
                            }}
                          >
                            ğŸš€ å¼€å§‹å­¦ä¹ 
                          </button>
                        )}
                        
                        {unit.progress?.status !== 'not_started' && !unit.progress?.sections?.reading?.completed && (
                          <button
                            onClick={() => completeSection(unit.id, 'reading', 30)}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#28a745',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '12px'
                            }}
                          >
                            âœ… å®Œæˆé˜…è¯»
                          </button>
                        )}
                        
                        {unit.progress?.sections?.reading?.completed && !unit.progress?.sections?.practice?.completed && (
                          <button
                            onClick={() => completeSection(unit.id, 'practice', 45)}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#ffc107',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '12px'
                            }}
                          >
                            âœ… å®Œæˆç»ƒä¹ 
                          </button>
                        )}
                        
                        {unit.progress?.sections?.reading?.completed && unit.progress?.sections?.practice?.completed && !unit.progress?.sections?.summary?.completed && (
                          <button
                            onClick={() => completeSection(unit.id, 'summary', 15)}
                            style={{
                              padding: '6px 12px',
                              backgroundColor: '#6f42c1',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '12px'
                            }}
                          >
                            âœ… å®Œæˆæ€»ç»“
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* å¿«é€Ÿæ“ä½œé¢æ¿ */}
              <div style={{
                padding: '15px',
                backgroundColor: '#fff3cd',
                borderRadius: '8px',
                border: '1px solid #ffeaa7'
              }}>
                <h4 style={{ margin: '0 0 10px 0', color: '#856404' }}>âš¡ å¿«é€Ÿæ“ä½œ</h4>
                <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                  <button
                    onClick={() => copyToClipboard(formatJSON(selectedNode ? getNodeUnits(selectedNode) : courseUnits))}
                    style={{
                      padding: '8px 15px',
                      backgroundColor: '#28a745',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px'
                    }}
                  >
                    ğŸ“‹ å¤åˆ¶æ•°æ®
                  </button>
                  <button
                    onClick={refreshData}
                    style={{
                      padding: '8px 15px',
                      backgroundColor: '#17a2b8',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '12px'
                    }}
                  >
                    ğŸ”„ åˆ·æ–°æ•°æ®
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ç®€åŒ–è§†å›¾ */}
          {!showCourseManagement && coreData?.courseUnits?.length > 0 && (
            <div style={{ fontSize: '14px', color: '#666' }}>
              <p>æ€»è¯¾ç¨‹å•å…ƒæ•°: <strong>{coreData.courseUnits.length}</strong></p>
              {courseStats && (
                <p>å®Œæˆç‡: <strong>{courseStats.completionRate}%</strong> 
                   | æ€»å­¦ä¹ æ—¶é•¿: <strong>{Math.round(courseStats.totalTimeSpent / 60)}å°æ—¶</strong></p>
              )}
            </div>
          )}
        </div>

        {/* AIåŠ¨ä½œè®°å½• */}
        {coreData?.agentActions?.length > 0 && (
          <div style={{
            padding: '15px',
            backgroundColor: '#ffffff',
            borderRadius: '8px',
            border: '1px solid #ddd'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h3 style={{ margin: 0, color: '#333' }}>ğŸ¤– AIåŠ¨ä½œè®°å½•</h3>
              <button
                onClick={() => copyToClipboard(formatJSON(coreData.agentActions))}
                style={{
                  padding: '5px 10px',
                  backgroundColor: '#28a745',
                  color: 'white',
                  border: 'none',
                  borderRadius: '3px',
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
              >
                ğŸ“‹ å¤åˆ¶
              </button>
            </div>
            <details style={{ marginTop: '10px' }}>
              <summary style={{ cursor: 'pointer', color: '#007bff' }}>
                å±•å¼€æŸ¥çœ‹ ({coreData.agentActions.length} ä¸ªåŠ¨ä½œè®°å½•)
              </summary>
              <pre style={{
                backgroundColor: '#f8f9fa',
                padding: '10px',
                borderRadius: '4px',
                fontSize: '12px',
                overflow: 'auto',
                maxHeight: '300px',
                marginTop: '10px'
              }}>
                {formatJSON(coreData.agentActions)}
              </pre>
            </details>
          </div>
        )}

        {/* èƒ½åŠ›è¯„ä¼°æ•°æ® */}
        {coreData?.currentAssessment && (
          <div style={{
            padding: '15px',
            backgroundColor: '#ffffff',
            borderRadius: '8px',
            border: '1px solid #ddd'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h3 style={{ margin: 0, color: '#333' }}>ğŸ“Š èƒ½åŠ›è¯„ä¼°æ•°æ®</h3>
              <button
                onClick={() => copyToClipboard(formatJSON(coreData.currentAssessment))}
                style={{
                  padding: '5px 10px',
                  backgroundColor: '#28a745',
                  color: 'white',
                  border: 'none',
                  borderRadius: '3px',
                  cursor: 'pointer',
                  fontSize: '12px'
                }}
              >
                ğŸ“‹ å¤åˆ¶
              </button>
            </div>
            <div style={{ marginTop: '10px', fontSize: '14px' }}>
              <p><strong>æ€»ä½“è¯„åˆ†ï¼š</strong> {coreData.currentAssessment.overallScore}/100</p>
              <p><strong>è¯„ä¼°æ—¥æœŸï¼š</strong> {coreData.currentAssessment.metadata.assessmentDate}</p>
              <p><strong>ç½®ä¿¡åº¦ï¼š</strong> {Math.round(coreData.currentAssessment.metadata.confidence * 100)}%</p>
            </div>
            <details style={{ marginTop: '10px' }}>
              <summary style={{ cursor: 'pointer', color: '#007bff' }}>
                å±•å¼€æŸ¥çœ‹å®Œæ•´è¯„ä¼°æ•°æ®
              </summary>
              <pre style={{
                backgroundColor: '#f8f9fa',
                padding: '10px',
                borderRadius: '4px',
                fontSize: '12px',
                overflow: 'auto',
                maxHeight: '300px',
                marginTop: '10px'
              }}>
                {formatJSON(coreData.currentAssessment)}
              </pre>
            </details>
          </div>
        )}

        {/* å…³è”ç®¡ç† */}
        <div style={{
          padding: '20px',
          backgroundColor: '#ffffff',
          borderRadius: '8px',
          border: '1px solid #ddd'
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, color: '#333' }}>ğŸ”— å…³è”ç®¡ç†</h3>
            <div style={{ display: 'flex', gap: '10px' }}>
              <button
                onClick={() => {
                  setShowRelationshipManagement(!showRelationshipManagement)
                  setShowCourseManagement(false)
                }}
                style={{
                  padding: '10px 20px',
                  backgroundColor: showRelationshipManagement ? '#28a745' : '#6c757d',
                  color: 'white',
                  border: 'none',
                  borderRadius: '5px',
                  cursor: 'pointer',
                  fontSize: '14px'
                }}
              >
                {showRelationshipManagement ? 'ğŸ”— éšè—å…³è”ç®¡ç†' : 'ğŸ”— æ˜¾ç¤ºå…³è”ç®¡ç†'}
              </button>
            </div>
          </div>

          {showRelationshipManagement ? (
            <EnhancedRelationshipPanel />
          ) : (
            relationshipStats && (
              <div style={{ fontSize: '14px', color: '#666' }}>
                <p>å…³è”ç»Ÿè®¡: <strong>{relationshipStats.goalsWithPaths}</strong> ä¸ªç›®æ ‡-è·¯å¾„å…³è”, 
                   <strong>{relationshipStats.courseUnitsWithSources}</strong> ä¸ªèŠ‚ç‚¹-è¯¾ç¨‹å…³è”</p>
                {(relationshipStats.orphanedPaths > 0 || relationshipStats.orphanedCourseUnits > 0) && (
                  <p style={{ color: '#dc3545' }}>
                    âš ï¸ å‘ç° <strong>{relationshipStats.orphanedPaths}</strong> ä¸ªå­¤ç«‹è·¯å¾„, 
                    <strong>{relationshipStats.orphanedCourseUnits}</strong> ä¸ªå­¤ç«‹è¯¾ç¨‹
                  </p>
                )}
                <div style={{ marginTop: '10px' }}>
                  <button
                    onClick={() => setShowRelationshipManagement(true)}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: '#007bff',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                      fontSize: '14px'
                    }}
                  >
                    ğŸš€ æ‰“å¼€æ™ºèƒ½å…³è”ç®¡ç†
                  </button>
                </div>
              </div>
            )
          )}
        </div>
      </div>

      {/* æµç¨‹è¯´æ˜ */}
      <div style={{
        marginTop: '30px',
        padding: '20px',
        backgroundColor: '#e3f2fd',
        borderRadius: '8px',
        border: '1px solid #bbdefb'
      }}>
        <h3 style={{ margin: '0 0 15px 0', color: '#1976d2' }}>ğŸ”„ æµç¨‹æ§åˆ¶è¯´æ˜</h3>
        <div style={{ fontSize: '14px', lineHeight: '1.6' }}>
          <p><strong>ç›®æ ‡çŠ¶æ€ç®¡ç†ï¼š</strong></p>
          <ul>
            <li>ğŸŸ¢ <strong>è¿›è¡Œä¸­</strong>ï¼šå¯ä»¥ç”Ÿæˆæ–°çš„å­¦ä¹ è·¯å¾„ï¼Œå¯æš‚åœæˆ–å®Œæˆ</li>
            <li>ğŸŸ¡ <strong>å·²æš‚åœ</strong>ï¼šç›¸å…³è·¯å¾„ä¹Ÿä¼šæš‚åœï¼Œå¯ä»¥æ¢å¤æˆ–å–æ¶ˆ</li>
            <li>ğŸ”µ <strong>å·²å®Œæˆ</strong>ï¼šå­¦ä¹ ç›®æ ‡å®Œæˆï¼Œå¯ä»¥é‡æ–°å¼€å§‹</li>
            <li>ğŸ”´ <strong>å·²å–æ¶ˆ</strong>ï¼šç›®æ ‡è¢«å–æ¶ˆï¼Œç›¸å…³è·¯å¾„å½’æ¡£ï¼Œå¯é‡æ–°æ¿€æ´»</li>
          </ul>
          
          <p><strong>è·¯å¾„çŠ¶æ€ç®¡ç†ï¼š</strong></p>
          <ul>
            <li>ğŸŸ¢ <strong>è¿›è¡Œä¸­</strong>ï¼šå½“å‰æ´»è·ƒçš„å­¦ä¹ è·¯å¾„ï¼Œå¯æš‚åœã€å®Œæˆæˆ–å½’æ¡£</li>
            <li>ğŸŸ¡ <strong>å·²æš‚åœ</strong>ï¼šæš‚æ—¶åœæ­¢çš„è·¯å¾„ï¼Œå¯æ¢å¤ã€å®Œæˆæˆ–å½’æ¡£</li>
            <li>ğŸ”’ <strong>å·²å†»ç»“</strong>ï¼šç”Ÿæˆæ–°è·¯å¾„æ—¶ï¼Œæ—§è·¯å¾„è‡ªåŠ¨å†»ç»“ï¼Œå¯æ¿€æ´»æˆ–å½’æ¡£</li>
            <li>ğŸ“ <strong>è‰ç¨¿</strong>ï¼šå¾…æ¿€æ´»çš„è·¯å¾„ï¼Œå¯å¯åŠ¨æˆ–å½’æ¡£</li>
            <li>ğŸ”µ <strong>å·²å®Œæˆ</strong>ï¼šå®Œæˆçš„è·¯å¾„ï¼Œå¯é‡æ–°å¼€å§‹</li>
            <li>ğŸ“¦ <strong>å·²å½’æ¡£</strong>ï¼šä¸å†ä½¿ç”¨çš„è·¯å¾„ï¼Œå¯é‡æ–°æ¿€æ´»</li>
          </ul>
          
          <p><strong>æ™ºèƒ½æµç¨‹æ§åˆ¶ï¼š</strong></p>
          <ul>
            <li>é‡æ–°è®¾å®šç›®æ ‡åï¼ŒåŸæœ‰è·¯å¾„ä¼šè¢«å†»ç»“ï¼Œç­‰å¾…é‡æ–°ç”Ÿæˆ</li>
            <li>å¯ä»¥æ¿€æ´»å†»ç»“çš„è·¯å¾„æˆ–è€…å½’æ¡£ä¸éœ€è¦çš„è·¯å¾„</li>
            <li>æ”¯æŒå¤šä¸ªç›®æ ‡å’Œè·¯å¾„çš„å¹¶è¡Œç®¡ç†</li>
          </ul>
          
          <p><strong>çŠ¶æ€è½¬æ¢æµç¨‹ï¼š</strong></p>
          <div style={{ 
            padding: '10px', 
            backgroundColor: '#f8f9fa', 
            borderRadius: '4px',
            fontSize: '12px',
            fontFamily: 'monospace'
          }}>
            <div><strong>ç›®æ ‡çŠ¶æ€æµè½¬ï¼š</strong></div>
            <div>è‰ç¨¿ â†’ è¿›è¡Œä¸­ â‡„ å·²æš‚åœ</div>
            <div>è¿›è¡Œä¸­ â†’ å·²å®Œæˆ / å·²å–æ¶ˆ</div>
            <div>å·²å®Œæˆ/å·²å–æ¶ˆ â†’ é‡æ–°æ¿€æ´»</div>
            <br />
            <div><strong>è·¯å¾„çŠ¶æ€æµè½¬ï¼š</strong></div>
            <div>è‰ç¨¿ â†’ è¿›è¡Œä¸­ â‡„ å·²æš‚åœ</div>
            <div>è¿›è¡Œä¸­ â†’ å·²å®Œæˆ / å·²å½’æ¡£</div>
            <div>å·²å†»ç»“ â†’ æ¿€æ´» / å½’æ¡£</div>
            <div>å·²å®Œæˆ/å·²å½’æ¡£ â†’ é‡æ–°æ¿€æ´»</div>
          </div>
        </div>
      </div>

      {/* ä½¿ç”¨è¯´æ˜ */}
      <div style={{
        marginTop: '20px',
        padding: '15px',
        backgroundColor: '#fff3cd',
        borderRadius: '8px',
        border: '1px solid #ffeaa7'
      }}>
        <h4 style={{ margin: '0 0 10px 0', color: '#856404' }}>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
        <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '14px', color: '#856404' }}>
          <li><strong>æ•°æ®ç®¡ç†ï¼š</strong> å¯ä»¥æŸ¥çœ‹å’Œåˆ é™¤å­¦ä¹ ç›®æ ‡ã€è·¯å¾„ã€è¯¾ç¨‹å•å…ƒ</li>
          <li><strong>çº§è”åˆ é™¤ï¼š</strong> åˆ é™¤å­¦ä¹ ç›®æ ‡ä¼šè‡ªåŠ¨åˆ é™¤ç›¸å…³çš„å­¦ä¹ è·¯å¾„å’Œè¯¾ç¨‹å†…å®¹</li>
          <li><strong>æ´»åŠ¨è®°å½•ï¼š</strong> æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½ä¼šè®°å½•åˆ°æ´»åŠ¨å†å²ä¸­</li>
          <li><strong>æ•°æ®å¯¼å‡ºï¼š</strong> ç‚¹å‡»"å¤åˆ¶æ•°æ®"æŒ‰é’®å¯ä»¥å¯¼å‡ºJSONæ ¼å¼çš„æ•°æ®</li>
          <li><strong>å®æ—¶æ›´æ–°ï¼š</strong> ç‚¹å‡»"åˆ·æ–°æ•°æ®"æŒ‰é’®å¯ä»¥è·å–æœ€æ–°çš„æ•°æ®çŠ¶æ€</li>
          <li><strong>è·¯å¾„ç®¡ç†ï¼š</strong> æ”¯æŒç›®æ ‡çŠ¶æ€æ§åˆ¶ã€è·¯å¾„ç”Ÿæˆã€æ¿€æ´»å’Œå½’æ¡£ç­‰æ“ä½œ</li>
        </ul>
      </div>

      {/* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† */}
      {deleteConfirm && (
        <DeleteConfirmDialog
          isOpen={deleteConfirm !== null}
          onClose={() => setDeleteConfirm(null)}
          onConfirm={confirmDelete}
          itemType={deleteConfirm?.type}
          itemTitle={deleteConfirm?.title}
        />
      )}
    </div>
  )
}

export default DataInspector 